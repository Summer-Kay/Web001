package com.scb.mxg.mls.rt.gfi.processor;

import com.scb.mxg.mls.rt.gfi.lookup.StaticDataDict;
import com.scb.mxg.mls.rt.gfi.utils.RegressionAssist;
import com.scb.mxg.mls.rt.gfi.utils.XmlUtils;
import com.scb.mxg.mls.rt.gfi.vo.Email;
import com.scb.mxg.mls.utils.XPathParser;
import org.apache.camel.Exchange;
import org.apache.commons.collections4.CollectionUtils;
import org.apache.commons.io.FileUtils;
import org.apache.commons.io.IOUtils;
import org.apache.commons.lang3.ObjectUtils;
import org.apache.commons.lang3.StringUtils;
import org.apache.commons.lang3.time.DateFormatUtils;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.xmlunit.builder.DiffBuilder;
import org.xmlunit.builder.Input;
import org.xmlunit.diff.Diff;
import org.xmlunit.diff.Difference;

import java.io.File;
import java.io.FileOutputStream;
import java.io.OutputStream;
import java.nio.file.Files;
import java.nio.file.Path;
import java.nio.file.Paths;
import java.util.*;

public final class UvtProcessor extends BaseProcessor {

	private final static Logger LOG = LoggerFactory
			.getLogger(UvtProcessor.class);

	private File expectedMxmlFolder;

	private File uvtTempFolder;

	public UvtProcessor() {
		Path rootDir = Paths.get(System.getProperty("root_dir")).toAbsolutePath().normalize();
		expectedMxmlFolder = createSecureFolder(rootDir,"uvt_expected");
		uvtTempFolder = createSecureFolder(rootDir,"uvt_temp");
		if (!expectedMxmlFolder.exists()) {
			expectedMxmlFolder.mkdirs();
		}
		LOG.info("regression expected mxml folder: {}",
				expectedMxmlFolder.getAbsolutePath());

		if (!uvtTempFolder.exists()) {
			uvtTempFolder.mkdirs();
		}
		LOG.info("uvt temp folder: {}", uvtTempFolder.getAbsolutePath());
	}

	@Override
	public void handleExchange(Exchange exchange) throws Exception {
		LOG.info("********* UVT Start *********");
		String dateFolderName = DateFormatUtils.ISO_DATE_FORMAT.format(new Date());
		Path uvtTmpDatePath = uvtTempFolder.toPath().resolve(dateFolderName).normalize();
		if (!uvtTmpDatePath.startsWith(uvtTempFolder.toPath())) {
			throw new SecurityException("Path traversal detected in date folder path");
		}
		File uvtTmpDateFolder = uvtTmpDatePath.toFile();
		Path baseDir = uvtTmpDateFolder.toPath();
		if (!uvtTmpDateFolder.exists()) {
			uvtTmpDateFolder.mkdirs();
		}
		String singleLegFixML = StringUtils.trimToEmpty(exchange.getIn().getBody(
				String.class));
		XPathParser intraXmlParser = new XPathParser(singleLegFixML);
		String legType = intraXmlParser.evaluate(CONFIG.getString("gfi.xpath.LegType"));
		String tradeExternalId = intraXmlParser.evaluate(CONFIG.getString("gfi.xpath.tradeExternalId"));
		String maxLegVal = intraXmlParser.evaluate(CONFIG.getString("gfi.xpath.MaxLegVal"));
		String legID =intraXmlParser.evaluate(CONFIG.getString("gfi.xpath.LegID"));
		String legSubID=intraXmlParser.evaluate(CONFIG.getString("gfi.xpath.LegSubID"));
		String externalId = getFullTradeId(tradeExternalId,legType,maxLegVal,legID,legSubID);

		LOG.info(externalId);

		// transform
		transformStages(exchange, singleLegFixML);
		Set<String> errors = StaticDataDict.getErrorList();

		// ================= compare =================
		Email email = new Email();
		String mxml = exchange.getIn().getBody(String.class);

		Path expectedMxmlPath = expectedMxmlFolder.toPath().resolve(externalId + ".xml").normalize();
		if (!expectedMxmlPath.startsWith(expectedMxmlFolder.toPath())) {
			throw new SecurityException("Path traversal detected in expected MXML path: " + externalId);
		}
		File expectedMxml = expectedMxmlPath.toFile();
		// save generated mxml
		Path generatedPath = uvtTmpDateFolder.toPath().resolve(externalId + ".generated.xml").normalize();
		if (!generatedPath.startsWith(uvtTmpDateFolder.toPath())) {
			throw new SecurityException("Path traversal detected in generated MXML path: " + externalId);
		}
		String generatedMxmlPath = generatedPath.toString();

		if (expectedMxml.exists()) {
			List<String> differenceList = new ArrayList<String>();
			String expectedMxmlStr = FileUtils.readFileToString(expectedMxml,
					"UTF-8");

			// save expected file
			Path expectedBackupPath = baseDir.resolve(externalId + ".expected.xml").normalize();
			if (!expectedBackupPath.toAbsolutePath().startsWith(baseDir.toAbsolutePath())) {
				throw new SecurityException("Path traversal detected in expected backup path: " + externalId);
			}
			try (OutputStream os = Files.newOutputStream(expectedBackupPath)) {
				IOUtils.write(expectedMxmlStr, os, "UTF-8");
			}

			Diff diff = DiffBuilder
					.compare(
							Input.fromString(StringUtils.trim(XmlUtils
									.formatXml(expectedMxmlStr))))
					.withTest(
							Input.fromString(StringUtils.trim(XmlUtils
									.formatXml(mxml)))).build();
			if (diff.hasDifferences()) {
				Iterator<Difference> differences = diff.getDifferences()
						.iterator();
				Difference difference = null;
				while (differences.hasNext()) {
					difference = differences.next();
					differenceList.add(difference.toString());
				}

				email.getContents().add("ID:&nbsp;&nbsp; " + externalId);
				email.getContents().add("<br/>");
				email.getContents().add("Status:&nbsp;&nbsp; <b>diff</b>");
				email.getContents().add("<br/>");
				email.getContents().add(" ");
				email.getContents().add("<br/>");
				email.getContents().add("Difference: ");
				email.getContents().add("<br/>");
				email.getContents().add("<ul>");

				for (String str : differenceList) {
					email.getContents().add("<li>" + str + "</li>");
				}
				email.getContents().add("</ul>");
				RegressionAssist.addRegressionResult(new RegressionAssist.RegressionResult(
						externalId, "diff", StringUtils.join(
						differenceList.toArray(), "\n")));
			} else {
				email.getContents().add("ID:&nbsp;&nbsp; " + externalId);
				email.getContents().add("<br/>");
				email.getContents().add("Status:&nbsp;&nbsp; <b>matched</b>");
				email.getContents().add("<br/>");
				RegressionAssist.addRegressionResult(new RegressionAssist.RegressionResult(
						externalId, "match", ""));
			}
		} else {
			email.getContents().add("ID:&nbsp;&nbsp; " + externalId);
			email.getContents().add("<br/>");
			email.getContents().add("Status:&nbsp;&nbsp; <b>diff</b>");
			email.getContents().add("<br/>");
			email.getContents().add(" ");
			email.getContents().add("<br/>");
			email.getContents().add("Difference: ");
			email.getContents().add("<br/>");
			email.getContents().add("<ul>");
			email.getContents().add(
					"<li>excepted file is not existing: "
							+ expectedMxml.getAbsolutePath() + "</li>");
			email.getContents().add("</ul>");
			email.getContents().add("<br/>");
			RegressionAssist.addRegressionResult(new RegressionAssist.RegressionResult(
					externalId, "failed", "excepted file is not existing: "
					+ expectedMxml.getAbsolutePath()));
		}
		if (CollectionUtils.isNotEmpty(errors)) {
			email.getContents().add(" ");
			email.getContents().add("<br/>");
			email.getContents().add("Remark: ");
			email.getContents().add("<br/>");
			email.getContents().add("<ul>");

			for (String str : errors) {
				email.getContents().add("<li>" + str + "</li>");
			}
			email.getContents().add("</ul>");
			email.getContents().add("<br/>");
		}
		email.getContents().add(" ");

		// save orginal message
		String orignalMsg = exchange.getProperty("originalMsg", String.class);
		XPathParser originalMsgParser = new XPathParser(orignalMsg);
		String gid = originalMsgParser.evaluate("/deal/gid_id");
		Path originalMsgFilePath = baseDir.resolve("original." + gid + ".xml").normalize();
		if (!originalMsgFilePath.toAbsolutePath().startsWith(baseDir.toAbsolutePath())) {
			throw new SecurityException("Path traversal detected in original message path: " + gid);
		}
		try (OutputStream os = Files.newOutputStream(originalMsgFilePath)) {
			IOUtils.write(orignalMsg, os, "UTF-8");
		}
		// save input fpml file
		Path inputFpmlFilePath = baseDir.resolve(externalId + ".input.xml").normalize();
		if (!inputFpmlFilePath.toAbsolutePath().startsWith(baseDir.toAbsolutePath())) {
			throw new SecurityException("Path traversal detected in input FPML path: " + externalId);
		}
		try (OutputStream os = Files.newOutputStream(inputFpmlFilePath)) {
			IOUtils.write(singleLegFixML, os, "UTF-8");
		}

		// save comparison result
		Path comparisonFilePath = baseDir.resolve(externalId + ".comparison.txt").normalize();

		if (!comparisonFilePath.toAbsolutePath().startsWith(baseDir.toAbsolutePath())) {
			throw new SecurityException("Path traversal detected in comparison file path: " + externalId);
		}

		try (OutputStream os = Files.newOutputStream(comparisonFilePath)) {
			IOUtils.writeLines(email.getContents(), IOUtils.LINE_SEPARATOR_WINDOWS, os);
		}

		email.getAttachments().add(originalMsgFilePath.toString());
		email.getAttachments().add(inputFpmlFilePath.toString());
		email.getAttachments().add(generatedMxmlPath);
		if (!ObjectUtils.isEmpty(expectedMxmlPath)) {
			email.getAttachments().add(expectedMxmlPath.toString());
		}

		// send result to mail
		exchange.setProperty("email", email);
		callProducer("freemarker:ftl/email4uvt.ftl?allowContextMapAll=true", exchange);
		exchange.getIn().removeHeaders("*");
		callProducer("mlsTunnelJmsC:topic:"
				+ getAppProperty("mlsTunnle.t.email"), exchange);

		LOG.info("********* UVT End *********");
	}

	private Path resolveSecurePath(Path baseDir, String fileName) {
		// 验证文件名
		if (fileName == null || fileName.contains("..") || fileName.contains("/") || fileName.contains("\\")) {
			throw new SecurityException("Invalid file name: " + fileName);
		}

		Path resolvedPath = baseDir.resolve(fileName).normalize();

		// 安全检查
		if (!resolvedPath.startsWith(baseDir)) {
			throw new SecurityException("Path traversal detected: " + fileName);
		}

		return resolvedPath;
	}

	private File createSecureFolder(Path baseDir, String folderName) {
		Path folderPath = resolveSecurePath(baseDir, folderName);
		File folder = folderPath.toFile();
		if (!folder.exists()) {
			folder.mkdirs();
		}
		return folder;
	}

}
