// 原代码（会报错）
File uvtTmpDateFolder = new File(uvtTempFolder.getAbsolutePath()
		+ File.separator
		+ DateFormatUtils.ISO_DATE_FORMAT.format(new Date()));

// 修复后
String dateFolderName = DateFormatUtils.ISO_DATE_FORMAT.format(new Date());
Path uvtTmpDatePath = uvtTempFolder.toPath().resolve(dateFolderName).normalize();
if (!uvtTmpDatePath.startsWith(uvtTempFolder.toPath())) {
    throw new SecurityException("Path traversal detected in date folder path");
}
File uvtTmpDateFolder = uvtTmpDatePath.toFile();



// 原代码（会报错）
File expectedMxml = new File(expectedMxmlFolder.getAbsolutePath()
		+ File.separator + externalId + ".xml");

// 修复后
Path expectedMxmlPath = expectedMxmlFolder.toPath().resolve(externalId + ".xml").normalize();
if (!expectedMxmlPath.startsWith(expectedMxmlFolder.toPath())) {
    throw new SecurityException("Path traversal detected in expected MXML path: " + externalId);
}
File expectedMxml = expectedMxmlPath.toFile();




// 原代码（会报错）
String generatedMxmlPath = uvtTmpDateFolder.getAbsolutePath()
		+ File.separator + externalId + ".generated.xml";

// 修复后
Path generatedPath = uvtTmpDateFolder.toPath().resolve(externalId + ".generated.xml").normalize();
if (!generatedPath.startsWith(uvtTmpDateFolder.toPath())) {
    throw new SecurityException("Path traversal detected in generated MXML path: " + externalId);
}
String generatedMxmlPath = generatedPath.toString();





// 原代码（会报错）
expectedMxmlPath = uvtTmpDateFolder.getAbsolutePath()
		+ File.separator + externalId + ".expected.xml";

// 修复后
Path expectedBackupPath = uvtTmpDateFolder.toPath().resolve(externalId + ".expected.xml").normalize();
if (!expectedBackupPath.startsWith(uvtTmpDateFolder.toPath())) {
    throw new SecurityException("Path traversal detected in expected backup path: " + externalId);
}
expectedMxmlPath = expectedBackupPath.toString();





// 原代码（会报错）
String originalMsgPath = uvtTmpDateFolder.getAbsolutePath()
		+ File.separator + "original." + gid + ".xml";

// 修复后
Path originalMsgFilePath = uvtTmpDateFolder.toPath().resolve("original." + gid + ".xml").normalize();
if (!originalMsgFilePath.startsWith(uvtTmpDateFolder.toPath())) {
    throw new SecurityException("Path traversal detected in original message path: " + gid);
}
String originalMsgPath = originalMsgFilePath.toString();








// 原代码（会报错）
String inputFpmlPath = uvtTmpDateFolder.getAbsolutePath()
		+ File.separator + externalId + ".input.xml";

// 修复后
Path inputFpmlFilePath = uvtTmpDateFolder.toPath().resolve(externalId + ".input.xml").normalize();
if (!inputFpmlFilePath.startsWith(uvtTmpDateFolder.toPath())) {
    throw new SecurityException("Path traversal detected in input FPML path: " + externalId);
}
String inputFpmlPath = inputFpmlFilePath.toString();








// 原代码（会报错）
IOUtils.writeLines(email.getContents(), IOUtils.LINE_SEPARATOR_WINDOWS,
		new FileOutputStream(uvtTmpDateFolder.getAbsolutePath()
				+ File.separator + externalId + ".comparison.txt"));

// 修复后
Path comparisonFilePath = uvtTmpDateFolder.toPath().resolve(externalId + ".comparison.txt").normalize();
if (!comparisonFilePath.startsWith(uvtTmpDateFolder.toPath())) {
    throw new SecurityException("Path traversal detected in comparison file path: " + externalId);
}
IOUtils.writeLines(email.getContents(), IOUtils.LINE_SEPARATOR_WINDOWS,
    new FileOutputStream(comparisonFilePath.toString()));



Path baseDir = uvtTmpDateFolder.toPath();
Path comparisonFilePath = baseDir.resolve(externalId + ".comparison.txt").normalize();

// 再次检查是否仍在限定目录下
if (!comparisonFilePath.toAbsolutePath().startsWith(baseDir.toAbsolutePath())) {
    throw new SecurityException("Path traversal detected in comparison file path: " + externalId);
}

// 使用 NIO Files.newOutputStream 代替 FileOutputStream（Sonar 推荐）
try (OutputStream os = Files.newOutputStream(comparisonFilePath)) {
    IOUtils.writeLines(email.getContents(), IOUtils.LINE_SEPARATOR_WINDOWS, os);
}


110
Path expectedBackupPath = uvtTmpDateFolder.toPath().resolve(externalId + ".expected.xml").normalize();
			if (!expectedBackupPath.startsWith(uvtTmpDateFolder.toPath())) {
				throw new SecurityException("Path traversal detected in expected backup path: " + externalId);
			}
			IOUtils.write(expectedMxmlStr, new FileOutputStream(
					expectedBackupPath.toString()), "UTF-8");


195
Path originalMsgFilePath = uvtTmpDateFolder.toPath().resolve("original." + gid + ".xml").normalize();
		if (!originalMsgFilePath.startsWith(uvtTmpDateFolder.toPath())) {
			throw new SecurityException("Path traversal detected in original message path: " + gid);
		}
		String originalMsgPath = originalMsgFilePath.toString();


203
Path inputFpmlFilePath = uvtTmpDateFolder.toPath().resolve(externalId + ".input.xml").normalize();
if (!inputFpmlFilePath.startsWith(uvtTmpDateFolder.toPath())) {
	throw new SecurityException("Path traversal detected in input FPML path: " + externalId);
}
String inputFpmlPath = inputFpmlFilePath.toString();
IOUtils.write(singleLegFixML, new FileOutputStream(inputFpmlPath), "UTF-8");


44
File f = new File(outputFolder.getAbsolutePath() + File.separator
				+ "GFI-" + new Date().getTime() + ".xls");

126
File f = new File(outputFolder.getAbsolutePath() + File.separator
				+ "GFI-" + new Date().getTime() + ".csv");



74 / 75
uvtInputFolder = new File(System.getProperty("root_dir")
                + File.separator + "regression_input");
if(!uvtInputFolder.exists()) {
    uvtInputFolder.mkdirs();
}
String filePath = uvtInputFolder.getPath() + "/generate_report.flag";
File file = new File(filePath);


104 / 105
String mxml = exchange.getIn().getBody(String.class);
FileUtils.write(new File(outputMxmlFolder.getAbsolutePath()+File.separator+externalId+".xml"),mxml);
File expectedMxml = new File(expectedMxmlFolder.getAbsolutePath()
