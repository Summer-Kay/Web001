package com.scb.mxg.mls.rt.gfi.processor;

import com.scb.mxg.mls.rt.gfi.vo.TradeEvent;
import com.scb.mxg.mls.trade.TradeEventType;
import com.scb.mxg.mls.utils.XPathParser;
import com.scb.mxg.mls.vo.Journal;
import org.apache.camel.Exchange;
import org.apache.camel.Message;
import org.apache.commons.lang3.StringUtils;
import org.junit.Before;
import org.junit.Test;
import org.junit.runner.RunWith;
import org.mockito.*;
import org.powermock.api.mockito.PowerMockito;
import org.powermock.core.classloader.annotations.PrepareForTest;
import org.powermock.modules.junit4.PowerMockRunner;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.jdbc.core.namedparam.NamedParameterJdbcTemplate;
import org.springframework.jdbc.core.JdbcTemplate;

import java.lang.reflect.Field;
import java.util.HashMap;
import java.util.Map;
import java.util.UUID;

import static org.junit.Assert.*;
import static org.mockito.ArgumentMatchers.*;
import static org.mockito.Mockito.*;

@RunWith(PowerMockRunner.class)
@PrepareForTest({LoggerFactory.class, StringUtils.class, StpProcessor.class, XPathParser.class, 
                NamedParameterJdbcTemplate.class, UUID.class})
public class StpProcessorTest {

    @Mock
    private Exchange exchange;
    
    @Mock
    private Message inMessage;
    
    @Mock
    private NamedParameterJdbcTemplate namedParameterJdbcTemplate;
    
    @Mock
    private JdbcTemplate mlsDbJdbcTemplate;
    
    @Mock
    private XPathParser intraXmlParser;
    
    @Mock
    private Logger logger;
    
    // 不使用@InjectMocks + @Spy组合
    private StpProcessor stpProcessor;
    
    private static final String ORIGINAL_TRACKING_ID = "test-tracking-id";
    private static final String SINGLE_LEG_FIX_ML = "<Trade><LegType>HedgeLegs</LegType><LegSubID>2</LegSubID><TradeExternalId>TRD123</TradeExternalId><MaxLegVal>100</MaxLegVal><LegID>1</LegID><TradeType>FX</TradeType><TradeDate>20230101</TradeDate><Trader>JohnDoe</Trader></Trade>";
    
    @Before
    public void setUp() throws Exception {
        MockitoAnnotations.initMocks(this);
        
        // 手动创建StpProcessor实例（可能需要通过反射设置父类字段）
        stpProcessor = new StpProcessor();
        
        // 通过反射设置父类(BaseProcessor)中的mlsDbJdbcTemplate字段
        Field mlsDbJdbcTemplateField = StpProcessor.class.getSuperclass().getDeclaredField("mlsDbJdbcTemplate");
        mlsDbJdbcTemplateField.setAccessible(true);
        mlsDbJdbcTemplateField.set(stpProcessor, mlsDbJdbcTemplate);
        
        // Mock静态方法
        PowerMockito.mockStatic(LoggerFactory.class);
        when(LoggerFactory.getLogger(StpProcessor.class)).thenReturn(logger);
        
        // Mock StringUtils
        PowerMockito.mockStatic(StringUtils.class);
        when(StringUtils.trimToEmpty(anyString())).thenReturn(SINGLE_LEG_FIX_ML);
        
        // Mock exchange properties
        when(exchange.getProperty(anyString(), eq(String.class)))
            .thenAnswer(invocation -> {
                String key = invocation.getArgument(0);
                if ("ORIGINAL_TRACKING_ID".equals(key)) {
                    return ORIGINAL_TRACKING_ID;
                }
                return null;
            });
        when(exchange.getIn()).thenReturn(inMessage);
        when(inMessage.getBody(String.class)).thenReturn(SINGLE_LEG_FIX_ML);
        
        // 模拟XPathParser的构造函数
        PowerMockito.whenNew(XPathParser.class)
                   .withArguments(SINGLE_LEG_FIX_ML)
                   .thenReturn(intraXmlParser);
        
        // 关键：模拟NamedParameterJdbcTemplate的构造函数
        PowerMockito.whenNew(NamedParameterJdbcTemplate.class)
                   .withArguments(mlsDbJdbcTemplate)
                   .thenReturn(namedParameterJdbcTemplate);
        
        // 模拟CONFIG
        mockConfigValues();
    }
    
    private void mockConfigValues() {
        // 模拟xpath评估
        when(intraXmlParser.evaluate(anyString())).thenAnswer(invocation -> {
            String xpath = invocation.getArgument(0);
            switch (xpath) {
                case "gfi.xpath.LegType": return "HedgeLegs";
                case "gfi.xpath.LegSubID": return "2";
                case "gfi.xpath.hedgeCurrency": return "USD";
                case "gfi.xpath.tradeExternalId": return "TRD123";
                case "gfi.xpath.MaxLegVal": return "100";
                case "gfi.xpath.LegID": return "1";
                case "gfi.xpath.tradeType": return "FX";
                case "gfi.xpath.tradeDate": return "20230101";
                case "gfi.xpath.trader": return "JohnDoe";
                default: return "";
            }
        });
        
        // 模拟CONFIG - 使用PowerMock模拟静态方法
        // 假设CONFIG是一个类的静态实例
        try {
            // 找到CONFIG字段
            Field configField = StpProcessor.class.getDeclaredField("CONFIG");
            configField.setAccessible(true);
            Object config = configField.get(null);
            
            // 如果是Mockable的对象，创建mock
            // 否则需要PowerMock.mockStatic对应的类
        } catch (Exception e) {
            // 如果不能模拟，可能需要修改测试策略
        }
    }
    
    @Test
    public void testHandleExchange_NewTrade() throws Exception {
        // Arrange
        // 模拟数据库查询返回0（交易不存在）
        when(namedParameterJdbcTemplate.queryForObject(
            anyString(), 
            any(Map.class), 
            eq(Long.class)))
            .thenReturn(0L);
        
        // 模拟UUID
        PowerMockito.mockStatic(UUID.class);
        UUID mockUuid = mock(UUID.class);
        when(UUID.randomUUID()).thenReturn(mockUuid);
        when(mockUuid.toString()).thenReturn("test-uuid");
        
        // 创建StpProcessor的spy来模拟部分方法
        StpProcessor spyProcessor = spy(stpProcessor);
        
        // 模拟父类方法（假设这些方法在BaseProcessor中）
        doNothing().when(spyProcessor).saveJournal(any(Exchange.class), any(Journal.class));
        doNothing().when(spyProcessor).recordTradeEvent(any(Exchange.class), any(TradeEvent.class));
        doNothing().when(spyProcessor).transformToMurex(
            any(Exchange.class), anyString(), anyString(), anyString(),
            anyString(), anyString(), anyString(), anyString());
        
        // Act
        spyProcessor.handleExchange(exchange);
        
        // Assert
        // 验证构造函数被调用
        PowerMockito.verifyNew(NamedParameterJdbcTemplate.class).withArguments(mlsDbJdbcTemplate);
        
        // 验证数据库查询被调用
        verify(namedParameterJdbcTemplate).queryForObject(anyString(), any(Map.class), eq(Long.class));
        
        // 验证exchange属性设置
        verify(exchange).setProperty(eq("_originalId"), anyString());
        verify(exchange).setProperty(eq("_originalSys"), anyString());
        verify(exchange).setProperty(eq("_version"), eq("test-uuid"));
    }
}




@Test
public void testIsExisting_MockQuery() throws Exception {
    // Arrange
    // 创建StpProcessor实例
    StpProcessor processor = new StpProcessor();
    
    // 通过反射设置mlsDbJdbcTemplate
    Field mlsDbJdbcTemplateField = StpProcessor.class.getSuperclass().getDeclaredField("mlsDbJdbcTemplate");
    mlsDbJdbcTemplateField.setAccessible(true);
    mlsDbJdbcTemplateField.set(processor, mlsDbJdbcTemplate);
    
    // 模拟NamedParameterJdbcTemplate构造函数
    PowerMockito.whenNew(NamedParameterJdbcTemplate.class)
               .withArguments(mlsDbJdbcTemplate)
               .thenReturn(namedParameterJdbcTemplate);
    
    String originalId = "TRD123_HedgeLegs_100_1_2";
    String originalSys = "GFI";
    
    // 模拟查询返回1
    when(namedParameterJdbcTemplate.queryForObject(
        anyString(),
        any(Map.class),
        eq(Long.class)))
        .thenReturn(1L);
    
    // 使用反射调用私有方法
    java.lang.reflect.Method method = StpProcessor.class.getDeclaredMethod(
        "isExisting", String.class, String.class);
    method.setAccessible(true);
    
    // Act
    boolean result = (boolean) method.invoke(processor, originalId, originalSys);
    
    // Assert
    assertTrue("交易应该存在", result);
    verify(namedParameterJdbcTemplate).queryForObject(anyString(), any(Map.class), eq(Long.class));
}
