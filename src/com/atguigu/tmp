package com.scb.mxg.mls.rt.gfi.utils;

import org.junit.Assert;
import org.junit.Test;

public class XPathParserTest {

    @Test
    public void testConstructorAndEvaluateAndGetXmlContent() throws Exception {
        String xml = "<root xmlns=\"http://test.com\">" +
                "<item>AAA</item>" +
                "<item>BBB</item>" +
                "<value>123</value>" +
                "</root>";

        XPathParser parser = new XPathParser(xml);

        // evaluate 找到多个节点 → 应只取第一个
        String itemValue = parser.evaluate("/*[local-name()='root']/*[local-name()='item']");
        Assert.assertEquals("AAA", itemValue);

        // evaluate 找不到节点
        String missingValue = parser.evaluate("/*[local-name()='root']/*[local-name()='not_exist']");
        Assert.assertEquals("", missingValue);

        // evaluate 单个节点
        String value = parser.evaluate("/*[local-name()='root']/*[local-name()='value']");
        Assert.assertEquals("123", value);

        // getXmlContent() 返回完整 XML
        String output = parser.getXmlContent();
        Assert.assertTrue(output.contains("<root"));
        Assert.assertTrue(output.contains("AAA"));
        Assert.assertTrue(output.contains("BBB"));
    }

    @Test
    public void testRemoveNode() throws Exception {
        String xml = "<root>" +
                "<a>1</a>" +
                "<a>2</a>" +
                "<b>3</b>" +
                "</root>";

        XPathParser parser = new XPathParser(xml);

        // 删除多个节点
        parser.removeNode("/root/a");

        String result = parser.getXmlContent();

        // <a> 节点应该全部被移除
        Assert.assertFalse(result.contains("<a>1</a>"));
        Assert.assertFalse(result.contains("<a>2</a>"));
        Assert.assertTrue(result.contains("<b>3</b>"));
    }

    @Test
    public void testNamespaceAwareXpath() throws Exception {
        // 测试 NamespaceContext，验证 XPathParser 中 lookupNamespaceURI 逻辑
        String xml =
                "<ns:root xmlns:ns=\"http://namespace.com\">" +
                        "<ns:child>OK</ns:child>" +
                "</ns:root>";

        XPathParser parser = new XPathParser(xml);

        // 使用 local-name() 不依赖命名空间 prefix
        String value = parser.evaluate("/*[local-name()='root']/*[local-name()='child']");
        Assert.assertEquals("OK", value);
    }

    @Test
    public void testConstructorWithoutXml() throws Exception {
        // 空构造 + 手动 init
        XPathParser parser = new XPathParser();
        XPathParser parser2 = new XPathParser("<x><y>hello</y></x>");

        Assert.assertEquals("hello",
                parser2.evaluate("/x/y"));
    }
}
