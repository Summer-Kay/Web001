@RunWith(PowerMockRunner.class)
@PowerMockIgnore({"javax.management.*","javax.script.*"})
@PrepareForTest({
        StaticDataDict.class,
        RegressionAssist.class,
        XmlUtils.class,
        FileUtils.class,
        XPathParser.class,
        DiffBuilder.class
})
public class RegressionTestProcessorTest {

    private RegressionTestProcessor processor;
    private Exchange exchange;

    private Path rootDir;
    private Path inputDir;
    private Path expectedDir;
    private Path outputDir;

    @Before
    public void setUp() throws Exception {
        // 创建临时 root_dir
        rootDir = Files.createTempDirectory("regression_root");
        System.setProperty("root_dir", rootDir.toString());

        inputDir = rootDir.resolve("regression_input");
        expectedDir = rootDir.resolve("regression_expected");
        outputDir = rootDir.resolve("regression_output");

        Files.createDirectories(inputDir);
        Files.createDirectories(expectedDir);
        Files.createDirectories(outputDir);

        // Mock Exchange
        exchange = Mockito.mock(Exchange.class);
        Mockito.when(exchange.getIn()).thenReturn(Mockito.mock(org.apache.camel.Message.class));
        Mockito.when(exchange.getIn().getBody(String.class)).thenReturn("<fixML/>");

        // Mock 静态类
        PowerMockito.mockStatic(StaticDataDict.class);
        PowerMockito.mockStatic(RegressionAssist.class);
        PowerMockito.mockStatic(XmlUtils.class);
        PowerMockito.mockStatic(FileUtils.class);
        PowerMockito.mockStatic(DiffBuilder.class);

        // 默认：没有错误
        Set<String> empty = new HashSet<>();
        Mockito.when(StaticDataDict.getErrorList()).thenReturn(empty);

        // 默认 XPathParser mock
        PowerMockito.whenNew(XPathParser.class)
                .withAnyArguments()
                .thenReturn(mockXPath());

        // 默认 XmlUtils.formatXml
        Mockito.when(XmlUtils.formatXml(Mockito.anyString()))
                .thenAnswer(i -> i.getArguments()[0]);

        processor = new RegressionTestProcessor();
    }

    private XPathParser mockXPath() throws Exception {
        XPathParser parser = Mockito.mock(XPathParser.class);
        Mockito.when(parser.evaluate(Mockito.anyString())).thenReturn("X");
        return parser;
    }

    // ---------- 1. flag 文件自动创建 ----------
    @Test
    public void testFlagFileCreated() throws Exception {
        File flag = inputDir.resolve("generate_report.flag").toFile();
        Assert.assertFalse(flag.exists());

        processor.handleExchange(exchange);

        Assert.assertTrue(flag.exists());
    }

    // ---------- 2. StaticDataDict 有错误 → failed ----------
    @Test
    public void testErrorListTriggersFailed() throws Exception {
        Set<String> errors = new HashSet<>();
        errors.add("ERROR_X");
        Mockito.when(StaticDataDict.getErrorList()).thenReturn(errors);

        processor.handleExchange(exchange);

        PowerMockito.verifyStatic(RegressionAssist.class);
        RegressionAssist.addRegressionResult(
                Mockito.argThat(r -> r.status.equals("failed"))
        );
    }

    // ---------- 3. expected 存在 & 匹配 ----------
    @Test
    public void testMatchCase() throws Exception {
        // expected XML
        File expected = expectedDir.resolve("X.xml").toFile();
        FileUtils.writeStringToFile(expected, "<a>1</a>", "UTF-8");

        // Mock reading expected
        Mockito.when(FileUtils.readFileToString(expected, "UTF-8"))
                .thenReturn("<a>1</a>");

        // Mock DiffBuilder → no differences
        Diff fakeDiff = Mockito.mock(Diff.class);
        Mockito.when(fakeDiff.hasDifferences()).thenReturn(false);

        PowerMockito.mockStatic(DiffBuilder.class);
        DiffBuilder builder = Mockito.mock(DiffBuilder.class);
        Mockito.when(DiffBuilder.compare(Mockito.any()))
                .thenReturn(builder);
        Mockito.when(builder.withTest(Mockito.any())).thenReturn(builder);
        Mockito.when(builder.build()).thenReturn(fakeDiff);

        processor.handleExchange(exchange);

        PowerMockito.verifyStatic(RegressionAssist.class);
        RegressionAssist.addRegressionResult(
                Mockito.argThat(r -> r.status.equals("match"))
        );
    }

    // ---------- 4. expected 存在 & 有差异 ----------
    @Test
    public void testDiffCase() throws Exception {
        File expected = expectedDir.resolve("X.xml").toFile();
        FileUtils.writeStringToFile(expected, "<a>1</a>", "UTF-8");

        Mockito.when(FileUtils.readFileToString(expected, "UTF-8"))
                .thenReturn("<a>1</a>");

        Difference diffEntry = Mockito.mock(Difference.class);
        Mockito.when(diffEntry.toString()).thenReturn("DIFF!");

        Diff fakeDiff = Mockito.mock(Diff.class);
        Mockito.when(fakeDiff.hasDifferences()).thenReturn(true);
        Mockito.when(fakeDiff.getDifferences())
                .thenReturn(Collections.singletonList(diffEntry));

        PowerMockito.mockStatic(DiffBuilder.class);
        DiffBuilder builder = Mockito.mock(DiffBuilder.class);
        Mockito.when(DiffBuilder.compare(Mockito.any()))
                .thenReturn(builder);
        Mockito.when(builder.withTest(Mockito.any())).thenReturn(builder);
        Mockito.when(builder.build()).thenReturn(fakeDiff);

        processor.handleExchange(exchange);

        PowerMockito.verifyStatic(RegressionAssist.class);
        RegressionAssist.addRegressionResult(
                Mockito.argThat(r -> r.status.equals("diff"))
        );
    }

    // ---------- 5. expected 文件不存在 ----------
    @Test
    public void testExpectedMissing() throws Exception {

        processor.handleExchange(exchange);

        PowerMockito.verifyStatic(RegressionAssist.class);
        RegressionAssist.addRegressionResult(
                Mockito.argThat(r -> r.status.equals("failed"))
        );
    }

    // ---------- 6. 路径逃逸触发 SecurityException ----------
    @Test(expected = SecurityException.class)
    public void testPathEscapeSecurity() throws Exception {
        // root_dir = /tmp/a
        // Exchange body 改造成逃逸路径
        Mockito.when(exchange.getIn().getBody(String.class)).thenReturn("<fixML/>");

        // 修改 System.getProperty 让路径在 normalize 后越界
        System.setProperty("root_dir", "/etc");

        RegressionTestProcessor p = new RegressionTestProcessor();
        p.handleExchange(exchange);
    }
}
