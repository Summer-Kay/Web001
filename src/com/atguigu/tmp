<dependency>
    <groupId>org.mockito</groupId>
    <artifactId>mockito-core</artifactId>
    <version>3.12.4</version>
    <scope>test</scope>
</dependency>

<dependency>
    <groupId>org.powermock</groupId>
    <artifactId>powermock-module-junit4</artifactId>
    <version>2.0.9</version>
    <scope>test</scope>
</dependency>

<dependency>
    <groupId>org.powermock</groupId>
    <artifactId>powermock-api-mockito2</artifactId>
    <version>2.0.9</version>
    <scope>test</scope>
</dependency>



@RunWith(PowerMockRunner.class)
@PrepareForTest({
        BaseProcessor.class,
        StaticDataDict.class,
        XPathParser.class
})
public class BaseProcessorTest {

    private BaseProcessor processor;
    private Exchange exchange;
    private JdbcTemplate jdbcTemplate;
    private TransactionTemplate txTemplate;

    @Before
    public void setup() throws Exception {

        // mock Camel
        exchange = Mockito.mock(Exchange.class);
        Mockito.when(exchange.getPattern()).thenReturn(ExchangePattern.InOut);

        // mock Jdbc
        jdbcTemplate = Mockito.mock(JdbcTemplate.class);
        txTemplate = Mockito.mock(TransactionTemplate.class);

        // mock StaticDataDict
        PowerMockito.mockStatic(StaticDataDict.class);
        Mockito.when(StaticDataDict.getErrorList()).thenReturn(new HashSet<>());
        Mockito.when(StaticDataDict.lookupTrader(Mockito.anyString())).thenReturn("T001");

        // mock XPathParser
        PowerMockito.whenNew(XPathParser.class)
                .withAnyArguments()
                .thenReturn(Mockito.mock(XPathParser.class));

        // create processor (anonymous subclass)
        processor = new BaseProcessor() {
            @Override
            public void handleExchange(Exchange exchange) throws Exception {
                // simple stub
                exchange.getIn().setBody("<test/>");
            }
        };

        processor.setMlsDbJdbcTemplate(jdbcTemplate);
        processor.setMlsDbTransactionTemplate(txTemplate);

        // mock transactionTemplate callback
        Mockito.when(txTemplate.execute(Mockito.any()))
                .thenAnswer(invocation -> {
                    TransactionCallback cb = invocation.getArgument(0);
                    return cb.doInTransaction(Mockito.mock(TransactionStatus.class));
                });
    }

    // ============ Test process() ============
    @Test
    public void testProcess() throws Exception {
        Message in = Mockito.mock(Message.class);
        Mockito.when(exchange.getIn()).thenReturn(in);
        processor.process(exchange);
        Mockito.verify(in, Mockito.atLeastOnce()).setBody(Mockito.any());
    }

    // ============ Test saveJournal() ============
    @Test
    public void testSaveJournal() throws Exception {
        Journal j = new Journal();
        j.setId("100");
        j.setContent("hello");
        j.setStatus("SENT");

        Message in = Mockito.mock(Message.class);
        Mockito.when(exchange.getProperty("isUVT", String.class)).thenReturn("N");
        Mockito.when(exchange.getIn()).thenReturn(in);

        processor.saveJournal(exchange, j);
        Mockito.verify(txTemplate, Mockito.times(1)).execute(Mockito.any());
    }

    // ============ Test transformStages() ============
    @Test
    public void testTransformStages_SMP() throws Exception {
        PowerMockito.whenNew(XPathParser.class).withAnyArguments()
                .thenReturn(mockParserWithTradeType("SMP"));

        Message in = Mockito.mock(Message.class);
        Mockito.when(exchange.getIn()).thenReturn(in);

        // call producer will NPE → mock掉
        PowerMockito.spy(processor);
        PowerMockito.doNothing().when((BaseProcessor)processor)
                .callProducer(Mockito.anyString(), Mockito.eq(exchange));

        processor.transformStages(exchange, "<msg/>");
    }

    @Test
    public void testTransformStages_Hedge() throws Exception {
        PowerMockito.whenNew(XPathParser.class).withAnyArguments()
                .thenReturn(mockParserWithTradeType("HEDGE"));

        Message in = Mockito.mock(Message.class);
        Mockito.when(exchange.getIn()).thenReturn(in);

        PowerMockito.spy(processor);
        PowerMockito.doNothing().when((BaseProcessor)processor)
                .callProducer(Mockito.anyString(), Mockito.eq(exchange));

        processor.transformStages(exchange, "<msg/>");
    }

    // helper
    private XPathParser mockParserWithTradeType(String tradeType) {
        XPathParser parser = Mockito.mock(XPathParser.class);
        Mockito.when(parser.evaluate(Mockito.anyString())).thenReturn(tradeType);
        return parser;
    }

    // ============ Test filter() ============
    @Test
    public void testFilter() throws Exception {
        Message in = Mockito.mock(Message.class);
        Mockito.when(in.getBody(String.class)).thenReturn("<A>1</A>");
        Mockito.when(exchange.getIn()).thenReturn(in);

        Document doc = DocumentHelper.parseText("<A>1</A>");
        PowerMockito.mockStatic(DocumentHelper.class);
        Mockito.when(DocumentHelper.parseText("<A>1</A>")).thenReturn(doc);

        PowerMockito.mockStatic(StaticDataDict.class);
        Mockito.when(StaticDataDict.getErrorList()).thenReturn(new HashSet<>());

        Assert.assertTrue(BaseProcessor.filter(exchange));
    }

    // ============ Test getFullTradeId ============
    @Test
    public void testGetFullTradeId() {
        String r = BaseProcessor.getFullTradeId("T100", "Legs", "3", "1", "1");
        Assert.assertTrue(r.contains("T100"));
    }

    // ============ Test calculateFXOAmount ============
    @Test
    public void testCalculateFXOAmount() {
        String r = BaseProcessor.calculateFXOAmount("USD", "USD", "USD",
                "100", "1.5", "1");
        Assert.assertEquals("100", r);
    }

    // ============ Test getters ============
    @Test
    public void testGetPutCurrency() {
        String r = BaseProcessor.getPutCurrency("2","USD","USDEUR");
        Assert.assertEquals("USD", r);
    }

}
